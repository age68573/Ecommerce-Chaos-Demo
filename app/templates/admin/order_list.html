{% extends "base.html" %}
{% block content %}
<h1 style="margin-bottom:1rem;">訂單管理（全使用者）</h1>

<div class="card" style="margin-bottom:1rem;">
  <form method="get" style="display:flex; gap:0.75rem; flex-wrap:wrap; align-items:end;">
    <div>
      <div style="font-size:0.85rem; color:#6b7280;">搜尋</div>
      <input type="text" name="q" value="{{ q or '' }}" placeholder="訂單ID / user_id / status"
             style="padding:0.45rem; min-width:260px;">
    </div>

    <div>
      <div style="font-size:0.85rem; color:#6b7280;">狀態</div>
      <select name="status" style="padding:0.45rem; min-width:160px;">
        <option value="">全部</option>
        {% for s in status_options %}
          <option value="{{ s }}" {% if status == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <div style="font-size:0.85rem; color:#6b7280;">起日</div>
      <input type="date" name="date_from" value="{{ date_from or '' }}" style="padding:0.45rem;">
    </div>

    <div>
      <div style="font-size:0.85rem; color:#6b7280;">迄日</div>
      <input type="date" name="date_to" value="{{ date_to or '' }}" style="padding:0.45rem;">
    </div>

    <div>
      <div style="font-size:0.85rem; color:#6b7280;">每頁</div>
      <select name="per_page" style="padding:0.45rem; min-width:90px;">
        {% for n in [10,20,50,100] %}
          <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <div style="display:flex; gap:0.5rem;">
      <button type="submit" class="btn btn-primary">套用</button>
      <a class="btn btn-outline" href="{{ url_for('admin_order.order_list_all') }}">清除</a>
    </div>
  </form>

  <div style="margin-top:0.75rem; font-size:0.85rem; color:#6b7280;">
    共 {{ total }} 筆
  </div>
</div>

{% if orders|length == 0 %}
  <div class="card">查無訂單</div>
{% else %}
<div style="display:flex; flex-direction:column; gap:1rem;">
  {% for o in orders %}
  <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.75rem;">
    <div>
      <div style="font-weight:700;">訂單 #{{ o.id }}</div>
      <div style="font-size:0.85rem; color:#6b7280;">
        user_id: {{ o.user_id }} ・ {{ o.created_at }}
      </div>
    </div>

    <div style="text-align:right;">
      <div style="font-weight:800;">${{ "%.2f"|format(o.total_amount) }}</div>
      <div style="font-size:0.85rem; color:#2563eb;">{{ o.status }}</div>
    </div>

    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
      <a class="btn btn-outline" href="{{ url_for('admin_order.order_detail_admin', order_id=o.id) }}">查看</a>

      <form method="post" action="{{ url_for('admin_order.order_delete_admin', order_id=o.id) }}"
            style="display:inline;"
            onsubmit="return confirm('確定要刪除訂單 #{{ o.id }} 嗎？（僅允許刪除 created/failed/cancelled）');">
        <button type="submit" class="btn btn-outline">刪除</button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>

{# ===== 分頁列 ===== #}
<div class="card" style="margin-top:1rem; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.75rem;">
  <div style="font-size:0.9rem; color:#6b7280;">
    第 {{ pagination.page }} / {{ pagination.pages }} 頁
  </div>

  <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
    {% set common = dict(q=q or '', status=status or '', date_from=date_from or '', date_to=date_to or '', per_page=per_page) %}

    {% if pagination.has_prev %}
      <a class="btn btn-outline" href="{{ url_for('admin_order.order_list_all', page=1, **common) }}">« 第一頁</a>
      <a class="btn btn-outline" href="{{ url_for('admin_order.order_list_all', page=pagination.prev_num, **common) }}">‹ 上一頁</a>
    {% else %}
      <span class="btn btn-outline" style="opacity:0.5; pointer-events:none;">« 第一頁</span>
      <span class="btn btn-outline" style="opacity:0.5; pointer-events:none;">‹ 上一頁</span>
    {% endif %}

    {% if pagination.has_next %}
      <a class="btn btn-outline" href="{{ url_for('admin_order.order_list_all', page=pagination.next_num, **common) }}">下一頁 ›</a>
      <a class="btn btn-outline" href="{{ url_for('admin_order.order_list_all', page=pagination.pages, **common) }}">最後頁 »</a>
    {% else %}
      <span class="btn btn-outline" style="opacity:0.5; pointer-events:none;">下一頁 ›</span>
      <span class="btn btn-outline" style="opacity:0.5; pointer-events:none;">最後頁 »</span>
    {% endif %}
  </div>
</div>

{% endif %}
{% endblock %}
