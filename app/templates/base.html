<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>{{ title or "E-commerce Chaos Demo" }}</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin:0; background:#f4f5f7; }
    header { background:#111827; color:#fff; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
    header a { color:#e5e7eb; margin-left:1rem; text-decoration:none; }
    main { padding:2rem; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1.5rem; }
    .card { background:#fff; border-radius:12px; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .btn { display:inline-block; padding:0.3rem 0.6rem; border-radius:6px; border:none; text-decoration:none; cursor:pointer; font-size:0.9rem; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-outline { border:1px solid #9ca3af; color:#111827; background:transparent; }
    img.product-thumb { max-width:100%; border-radius:8px; display:block; margin-bottom:0.5rem; }
    .dropdown { display:inline-block; position:relative; }
    .dropbtn {
      background: transparent;
      border: none;
      color:#e5e7eb;
      cursor:pointer;
      font-size:1rem;
      margin-left:1rem;
    }
    .dropdown-content {
      display:none;
      position:absolute;
      background:#111827;
      min-width: 160px;
      box-shadow:0 8px 16px rgba(0,0,0,0.2);
      border-radius:8px;
      overflow:hidden;
      z-index:999;
    }
    .dropdown-content a {
      display:block;
      padding:0.6rem 0.8rem;
      color:#e5e7eb;
      text-decoration:none;
      white-space:nowrap;
    }
    .dropdown-content a:hover { background:#1f2937; }
    .dropdown:hover .dropdown-content { display:block; }

  </style>

  {# ==== Instana EUM 基本 script ==== #}
  <script>
    (function(s,t,a,n){s[t]||(s[t]=a,n=s[a]=function(){n.q.push(arguments)},
    n.q=[],n.v=2,n.l=1*new Date)})(window,"InstanaEumObject","ineum");

    ineum('reportingUrl', 'https://instana-k3s.palsys.com.tw/eum/');
    ineum('key', 'TxpUsyC0SCGzCe4wBsIyXw');
    ineum('trackSessions');
  </script>
  <script defer crossorigin="anonymous"
          src="https://instana-k3s.palsys.com.tw/eum/1.8.1/eum.min.js"
          integrity="sha384-qFzHZ5BC7HOPEBSYkbYSv+DBWrG34P1QW9mIaCR41db6yOJNYmH4antW6KLkc6v1">
  </script>

  {# ==== Instana user / page API ==== #}
  <script>
    // pageName：預設用後端傳入的 page_name，沒有就 fallback 到目前路徑
    document.addEventListener('DOMContentLoaded', function () {
      try {
        var pageName = {{ (page_name or request.path)|tojson }};
        ineum('page', pageName);
      } catch (e) {
        // 避免頁面壞掉，不要 throw
      }

      {% if current_user %}
      try {
        ineum(
          'user',
          {{ current_user.id|tojson }},
          {{ current_user.username|tojson }},
          {{ current_user.email|tojson }}
        );
      } catch (e) {}
      {% endif %}
    });
  </script>
</head>
<body>
  <header>
    <div>E-commerce Chaos Demo</div>
    <nav>
      <a href="/">首頁</a>
      <a href="/products">商品列表</a>

      {% if current_user %}
        <a href="/cart/">購物車</a>
        <a href="/orders/">我的訂單</a>
      {% endif %}

      {% if current_user and current_user.is_admin %}
        <div class="dropdown">
          <button class="dropbtn">管理 ▾</button>
          <div class="dropdown-content">
            <a href="/admin/products/">後台商品</a>
            <a href="/admin/users/">會員管理</a>
            <a href="/admin/orders/">訂單管理</a>
          </div>
        </div>

        <a href="/admin/chaos/">Chaos 控制台</a>
      {% endif %}

      {% if current_user %}
        <span style="margin-left:1rem; font-size:0.9rem;">Hi, {{ current_user.username }}</span>
        <a href="{{ url_for('auth.logout') }}">登出</a>
      {% else %}
        <a href="{{ url_for('auth.login') }}">登入</a>
      {% endif %}
    </nav>
  </header>
  <main>
    {% block content %}{% endblock %}
  </main>
</body>
</html>
